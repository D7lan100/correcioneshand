{% extends "base.html" %}
{% block title %}Panel de Personalizaci√≥n - HandiGenius{% endblock %}

{% block content %}
<style>
  .panel-container {
    margin-top: 40px;
    padding: 30px;
    border-radius: 20px;
    background: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  .opciones-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
    margin-top: 30px;
  }

  .opcion-card {
    background: #f8faff;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    border: 1px solid #e0e6f1;
  }

  .opcion-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    border-color: #cce0ff;
  }

  .opcion-card i {
    font-size: 42px;
    color: #007bff;
    margin-bottom: 15px;
  }

  /* Bot√≥n Enviar / Subir */
  .btn-enviar {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 10px;
    padding: 10px 25px;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
  }

  .btn-enviar:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 123, 255, 0.4);
  }

  textarea {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #ccd8eb;
    padding: 10px;
    resize: none;
    font-size: 15px;
    transition: border 0.3s ease;
  }

  textarea:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0,123,255,0.3);
  }

  /* Estilo sobrio para input file */
  input[type="file"] {
    display: block;
    margin: 10px auto;
    border: 1px solid #dcdfe6;
    border-radius: 10px;
    padding: 8px;
    background-color: #f9fbff;
    font-size: 14px;
    width: 90%;
    cursor: pointer;
    color: #555;
  }

  input[type="file"]::file-selector-button {
    background-color: #f2f4f8;
    color: #333;
    border: 1px solid #d0d5dc;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  input[type="file"]::file-selector-button:hover {
    background-color: #e6e8ed;
  }

  .btn-volver {
    position: fixed !important;
    top: 80px;
    left: 25px;
    background-color: #007bff !important;
    color: #fff !important;
    padding: 10px 18px;
    border-radius: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    text-decoration: none !important;
    transition: all 0.25s ease-in-out;
    z-index: 9999;
  }

  .btn-volver:hover {
    background-color: #0056b3 !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 123, 255, 0.45);
    color: #fff !important;
  }

  .btn-volver i {
    font-size: 1.1rem;
  }
</style>

<a href="{{ url_for('productos_bp.detalle_producto', id_producto=id_producto) }}" 
   class="btn-volver">
  <i class="bi bi-arrow-left"></i> Volver al producto
</a>

<div class="container panel-container">
  <h2 class="text-center mb-4">
    <i class="bi bi-brush"></i> Elige tu tipo de personalizaci√≥n
  </h2>

  <div class="opciones-grid">
    <!-- Opci√≥n 1 -->
    <div class="opcion-card" onclick="window.location.href='{{ url_for('productos_bp.personalizar', id_producto=id_producto) }}'">
        <i class="bi bi-flower3"></i>
        <h5>Plantilla de personalizaci√≥n</h5>
        <p>Elige los colores, flores y cinta de forma interactiva.</p>
    </div>

    <!-- Opci√≥n 2 -->
    <div class="opcion-card" id="textoLibreCard">
      <i class="bi bi-pencil-square"></i>
      <h5>Texto Libre</h5>
      <p>Escribe detalladamente c√≥mo te gustar√≠a personalizar tu producto.</p>

      <form id="formTextoLibre" style="display:none;">
        <textarea id="textoPersonalizado" name="texto_personalizado" rows="4" placeholder="Describe tu idea aqu√≠..." required></textarea>
        <button type="submit" class="btn-enviar mt-2">Enviar</button>
      </form>
    </div>

    <!-- Opci√≥n 3 -->
    <div class="opcion-card" id="bocetoCard">
      <i class="bi bi-upload"></i>
      <h5>Subir Boceto</h5>
      <p>Sube una imagen o dibujo de c√≥mo quieres tu producto.</p>

      <form id="formBoceto" enctype="multipart/form-data" style="display:none;">
        <input type="file" id="imagenBoceto" name="imagen_personalizada" accept="image/*" required>
        <button type="submit" class="btn-enviar">Subir Boceto</button>
      </form>
    </div>

    <!-- Opci√≥n 4 -->
    <div class="opcion-card" id="formularioGuiado">
      <i class="bi bi-ui-checks"></i>
      <h5>Formulario Guiado</h5>
      <p>Responde unas preguntas para que creemos tu dise√±o ideal.</p>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const textoLibreCard = document.getElementById("textoLibreCard");
  const formTextoLibre = document.getElementById("formTextoLibre");
  const bocetoCard = document.getElementById("bocetoCard");
  const formBoceto = document.getElementById("formBoceto");
  const formularioGuiado = document.getElementById("formularioGuiado");

  // Mostrar/ocultar texto libre
  textoLibreCard.addEventListener("click", (e) => {
    if (e.target.closest("form")) return;
    formTextoLibre.style.display =
      formTextoLibre.style.display === "none" ? "block" : "none";
  });

  // Mostrar/ocultar subir boceto
  bocetoCard.addEventListener("click", (e) => {
    if (e.target.closest("form")) return;
    formBoceto.style.display =
      formBoceto.style.display === "none" ? "block" : "none";
  });

  // Enviar texto libre con confirmaci√≥n moderna
  formTextoLibre.addEventListener("submit", async (e) => {
    e.preventDefault();

    const texto = document.getElementById("textoPersonalizado").value.trim();
    if (!texto) {
      Swal.fire({
        title: "‚ö†Ô∏è Campo vac√≠o",
        text: "Por favor escribe un texto antes de enviar.",
        icon: "warning",
        confirmButtonColor: "#3085d6"
      });
      return;
    }

    const confirmacion = await Swal.fire({
      title: "¬øGuardar texto personalizado?",
      text: "¬øDeseas guardar esta descripci√≥n en tu pedido?",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "S√≠, guardar",
      cancelButtonText: "Cancelar",
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33"
    });

    if (!confirmacion.isConfirmed) return;

    try {
      const response = await fetch(`/guardar_texto_personalizado/{{ id_producto }}`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `texto_personalizado=${encodeURIComponent(texto)}`
      });

      const result = await response.json();
      if (result.success) {
        Swal.fire({
          title: "‚úÖ ¬°Guardado con √©xito!",
          text: "Tu texto personalizado fue registrado correctamente.",
          icon: "success",
          confirmButtonColor: "#3085d6"
        });
      } else {
        Swal.fire({
          title: "‚ùå Error al guardar",
          text: result.message,
          icon: "error",
          confirmButtonColor: "#d33"
        });
      }
    } catch (error) {
      Swal.fire({
        title: "‚ö†Ô∏è Error de conexi√≥n",
        text: "No se pudo conectar con el servidor.",
        icon: "warning",
        confirmButtonColor: "#d33"
      });
    }
  });

  // Subir boceto con confirmaci√≥n moderna
  formBoceto.addEventListener("submit", async (e) => {
    e.preventDefault();

    const file = document.getElementById("imagenBoceto").files[0];
    if (!file) {
      Swal.fire({
        title: "‚ö†Ô∏è Archivo no seleccionado",
        text: "Selecciona una imagen antes de subir.",
        icon: "warning",
        confirmButtonColor: "#3085d6"
      });
      return;
    }

    const confirmacion = await Swal.fire({
      title: "¬øSubir boceto?",
      text: "¬øDeseas guardar esta imagen como referencia personalizada?",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "S√≠, subir",
      cancelButtonText: "Cancelar",
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33"
    });

    if (!confirmacion.isConfirmed) return;

    const formData = new FormData();
    formData.append("imagen_personalizada", file);

    try {
      const response = await fetch(`/subir_boceto/{{ id_producto }}`, {
        method: "POST",
        body: formData
      });

      if (response.ok) {
        Swal.fire({
          title: "‚úÖ ¬°Boceto subido!",
          text: "Tu imagen fue registrada correctamente.",
          icon: "success",
          confirmButtonColor: "#3085d6"
        });
      } else {
        Swal.fire({
          title: "‚ùå Error al subir",
          text: "Ocurri√≥ un problema al guardar el boceto.",
          icon: "error",
          confirmButtonColor: "#d33"
        });
      }
    } catch (error) {
      Swal.fire({
        title: "‚ö†Ô∏è Error de conexi√≥n",
        text: "No se pudo conectar con el servidor.",
        icon: "warning",
        confirmButtonColor: "#d33"
      });
    }
  });

  // Registrar el formulario guiado del usuario
  formularioGuiado.addEventListener("click", async () => {
    const confirmacion = await Swal.fire({
      title: "Abrir Formulario Guiado",
      text: "¬øDeseas abrir el formulario para personalizar tu producto?",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "S√≠, abrir",
      cancelButtonText: "Cancelar",
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33"
    });

    if (!confirmacion.isConfirmed) return;

    // ‚ö†Ô∏è Nueva alerta informativa antes de abrir el formulario
    await Swal.fire({
      title: "üìù Importante",
      text: "Por favor llena los datos del formulario con los mismos que usas en tu perfil de Hand&Genius. Esto permitir√° asociar correctamente tu dise√±o personalizado.",
      icon: "info",
      confirmButtonText: "Entendido",
      confirmButtonColor: "#3085d6"
    });

    try {
      const response = await fetch(`/registrar_formulario/{{ id_producto }}`, {
        method: "POST"
      });

      const result = await response.json();
      if (result.success) {
        window.open(
          "https://docs.google.com/forms/d/e/1FAIpQLSd_4_pbEEvv6_ctztJn_qK6pudaKtG2OHcybPEoQlucAm-aIA/viewform?usp=dialog",
          "_blank"
        );
      } else {
        Swal.fire({
          title: "‚ùå Error",
          text: "No se pudo registrar la acci√≥n en el sistema.",
          icon: "error",
          confirmButtonColor: "#d33"
        });
      }
    } catch (error) {
      Swal.fire({
        title: "‚ö†Ô∏è Error de conexi√≥n",
        text: "No se pudo conectar con el servidor.",
        icon: "warning",
        confirmButtonColor: "#d33"
      });
    }
  });
});
</script>

{% endblock %}