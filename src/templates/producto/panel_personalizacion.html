{% extends "base.html" %}
{% block title %}Panel de Personalizaci√≥n - HandiGenius{% endblock %}

{% block content %}
<style>
  /* --- ESTILOS ORIGINALES --- */
  .panel-container {
    margin-top: 40px;
    padding: 30px;
    border-radius: 20px;
    background: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  .opciones-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
    margin-top: 30px;
  }

  .opcion-card {
    background: #f8faff;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    border: 1px solid #e0e6f1;
  }

  /* Clase para cuando la tarjeta est√° activa (formulario abierto) */
  .opcion-card.active {
    grid-column: 1 / -1; /* Ocupa todo el ancho si el grid lo permite */
    background: #fff;
    border-color: #007bff;
    cursor: default;
    transform: none !important; /* Quitar efecto hover */
  }

  .opcion-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    border-color: #cce0ff;
  }
  
  /* Quitar efecto hover si est√° activa */
  .opcion-card.active:hover {
    transform: none;
  }

  .opcion-card i {
    font-size: 42px;
    color: #007bff;
    margin-bottom: 15px;
  }

  /* Bot√≥n Enviar / Subir */
  .btn-enviar {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 10px;
    padding: 10px 25px;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
    margin-top: 10px;
  }

  .btn-enviar:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 123, 255, 0.4);
  }

  textarea, select, input[type="text"], input[type="date"] {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #ccd8eb;
    padding: 10px;
    resize: none;
    font-size: 15px;
    transition: border 0.3s ease;
    margin-bottom: 10px;
    background: #fff;
  }

  textarea:focus, select:focus, input[type="text"]:focus, input[type="date"]:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0,123,255,0.3);
  }

  /* Estilo sobrio para input file */
  input[type="file"] {
    display: block;
    margin: 10px auto;
    border: 1px solid #dcdfe6;
    border-radius: 10px;
    padding: 8px;
    background-color: #f9fbff;
    font-size: 14px;
    width: 90%;
    cursor: pointer;
    color: #555;
  }

  input[type="file"]::file-selector-button {
    background-color: #f2f4f8;
    color: #333;
    border: 1px solid #d0d5dc;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  input[type="file"]::file-selector-button:hover {
    background-color: #e6e8ed;
  }

  .btn-volver {
    position: fixed !important;
    top: 80px;
    left: 25px;
    background-color: #007bff !important;
    color: #fff !important;
    padding: 10px 18px;
    border-radius: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    text-decoration: none !important;
    transition: all 0.25s ease-in-out;
    z-index: 9999;
  }

  .btn-volver:hover {
    background-color: #0056b3 !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 123, 255, 0.45);
    color: #fff !important;
  }

  .btn-volver i {
    font-size: 1.1rem;
  }

  /* --- NUEVOS ESTILOS PARA EL FORMULARIO GUIADO --- */
  .form-guiado-container {
      text-align: left; /* Alinear el formulario a la izquierda */
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
  }
  
  .form-group label {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      display: block;
  }

  .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
  }

  .checkbox-item {
      background: #fff;
      border: 1px solid #ddd;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
  }

  .checkbox-item:hover {
      border-color: #007bff;
      background: #f0f7ff;
  }
  
  .checkbox-item input {
      accent-color: #007bff;
  }
</style>

<a href="{{ url_for('productos_bp.detalle_producto', id_producto=id_producto) }}" 
   class="btn-volver">
  <i class="bi bi-arrow-left"></i> Volver al producto
</a>

<div class="container panel-container">
  <h2 class="text-center mb-4">
    <i class="bi bi-brush"></i> Elige tu tipo de personalizaci√≥n
  </h2>

  <div class="opciones-grid">
    <div class="opcion-card" onclick="window.location.href='{{ url_for('productos_bp.personalizar', id_producto=id_producto) }}'">
        <i class="bi bi-flower3"></i>
        <h5>Plantilla de personalizaci√≥n</h5>
        <p>Elige los colores, flores y cinta de forma interactiva.</p>
    </div>

    <div class="opcion-card" id="textoLibreCard">
      <i class="bi bi-pencil-square"></i>
      <h5>Texto Libre</h5>
      <p>Escribe detalladamente c√≥mo te gustar√≠a personalizar tu producto.</p>

      <form id="formTextoLibre" style="display:none;">
        <textarea id="textoPersonalizado" name="texto_personalizado" rows="4" placeholder="Describe tu idea aqu√≠..." required></textarea>
        <button type="submit" class="btn-enviar mt-2">Enviar</button>
      </form>
    </div>

    <div class="opcion-card" id="bocetoCard">
      <i class="bi bi-upload"></i>
      <h5>Subir Boceto</h5>
      <p>Sube una imagen o dibujo de c√≥mo quieres tu producto.</p>

      <form id="formBoceto" enctype="multipart/form-data" style="display:none;">
        <input type="file" id="imagenBoceto" name="imagen_personalizada" accept="image/*" required>
        <button type="submit" class="btn-enviar">Subir Boceto</button>
      </form>
    </div>

    <div class="opcion-card" id="formularioGuiadoCard">
      <i class="bi bi-ui-checks"></i>
      <h5>Formulario Guiado</h5>
      <p>Responde unas preguntas para que creemos tu dise√±o ideal.</p>

      <form id="formGuiado" class="form-guiado-container" style="display:none;">
        <!-- --- Descripci√≥n preliminar --- -->
        <div class="form-group">
          <p>
            <strong>En Hand&Genius ofrecemos ramos y cartas personalizados</strong>, creados especialmente seg√∫n tus indicaciones para que cada detalle tenga un significado √∫nico.
          </p>
          <p>
            üíê <strong>Ramos personalizados:</strong> elige tipo de flores, colores, estilo y adornos.<br>
            üíå <strong>Cartas personalizadas:</strong> incluye tus propias palabras, un p√°rrafo especial o un mensaje emotivo.
          </p>
          <p>
            A trav√©s de este formulario nos cuentas los detalles. <em>Ignora la secci√≥n que no corresponda al producto que vas a adquirir.</em>
          </p>
          <p style="font-size:0.9rem;color:#6b6b6b;">
            <strong>IMPORTANTE:</strong> Algunas solicitudes podr√≠an no ser posibles exactamente como se piden. El vendedor respondera tu solicitud mediante el carrito de compras o tus datos de contacto, para ofrecer variantes o ajustes y acordar el precio adicional si aplica.
          </p>
        </div>

        <!-- --- Datos de contacto (obligatorios) --- -->
        <h6>Datos de contacto <span style="color:#d33;">*</span></h6>
        <div class="form-group">
          <label>Nombre completo: <span style="color:#d33">*</span></label>
          <input type="text" name="contact_nombre" required placeholder="Ej: Juan P√©rez">
        </div>
        <div class="form-group">
          <label>Correo electr√≥nico: <span style="color:#d33">*</span></label>
          <input type="email" name="contact_email" required placeholder="ejemplo@correo.com">
        </div>
        <div class="form-group">
          <label>Tel√©fono: <span style="color:#d33">*</span></label>
          <input type="text" name="contact_telefono" required placeholder="+57 3XX XXX XXXX">
        </div>

        <!-- --- Producto a personalizar (obligatorio) --- -->
        <h6>Producto a personalizar <span style="color:#d33">*</span></h6>
        <div class="form-group">
          <label>Nombre/Referencia del producto (nombre, proveedor y/o URL) <span style="color:#d33">*</span></label>
          <input type="text" name="producto_info" required placeholder="Ej: Ramo rom√°ntico - Vendedor XYZ - https://...">
        </div>

        <!-- --- Sobre el destinatario --- -->
        <h6>Sobre el destinatario</h6>
        <div class="form-group">
          <label>¬øPara qui√©n es el regalo? <span style="color:#d33">*</span></label>
          <input type="text" name="destinatario_nombre" required placeholder="Ej: Mar√≠a ">
        </div>

        <div class="form-group">
          <label>¬øQu√© relaci√≥n tienes con la persona?</label>
          <div class="checkbox-group" style="gap:8px;">
            <label class="checkbox-item"><input type="radio" name="relacion" value="Pareja" required> Pareja üíï</label>
            <label class="checkbox-item"><input type="radio" name="relacion" value="Familiar"> Familiar üë®‚Äçüë©‚Äçüëß‚Äçüë¶</label>
            <label class="checkbox-item"><input type="radio" name="relacion" value="Amigo"> Amigo/a ü§ù</label>
            <label class="checkbox-item"><input type="radio" name="relacion" value="Colega"> Colega/Trabajo üíº</label>
            <label class="checkbox-item"><input type="radio" name="relacion" value="Otros"> Otros</label>
            <input type="text" name="relacion_otro" placeholder="Si elegiste 'Otros', escribe aqu√≠..." style="width:100%; margin-top:6px;">
          </div>
        </div>

        <!-- --- Sobre la ocasi√≥n --- -->
        <h6>Sobre la ocasi√≥n <span style="color:#d33">*</span></h6>
        <div class="form-group">
          <label>¬øQu√© ocasi√≥n se celebra?</label>
          <select name="ocasion" required>
            <option value="" disabled selected>Selecciona una...</option>
            <option value="Cumplea√±os">Cumplea√±os üéÇ</option>
            <option value="Aniversario">Aniversario ‚ù§</option>
            <option value="Graduaci√≥n">Graduaci√≥n üéì</option>
            <option value="D√≠a de la Madre">D√≠a de la Madre üë©‚Äçüë¶</option>
            <option value="D√≠a del Padre">D√≠a del Padre üë®‚Äçüëß</option>
            <option value="San Valent√≠n">San Valent√≠n üíò</option>
            <option value="Condolencias">Condolencias</option>
            <option value="Otro">Otro (especificar en detalles)</option>
          </select>
        </div>

        <!-- --- Preferencias de estilo --- -->
        <h6>Preferencias de estilo <span style="color:#d33">*</span></h6>
        <div class="form-group">
          <label>¬øQu√© estilo prefieres para el regalo?</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="radio" name="estilo" value="Rom√°ntico" required> Rom√°ntico üíñ</label>
            <label class="checkbox-item"><input type="radio" name="estilo" value="Elegante"> Elegante ‚ú®</label>
            <label class="checkbox-item"><input type="radio" name="estilo" value="Divertido"> Divertido üéâ</label>
            <label class="checkbox-item"><input type="radio" name="estilo" value="Minimalista"> Minimalista ‚ö™</label>
            <label class="checkbox-item"><input type="radio" name="estilo" value="Colorido"> Colorido üåà</label>
            <label class="checkbox-item"><input type="radio" name="estilo" value="Otros"> Otros</label>
            <input type="text" name="estilo_otro" placeholder="Si elegiste 'Otros', escribe aqu√≠..." style="width:100%; margin-top:6px;">
          </div>
        </div>

        <!-- --- Mensaje personalizado --- -->
        <div class="form-group">
          <label>¬øQuieres incluir un mensaje personalizado? cual?</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="radio" name="incluir_mensaje" value="S√≠"> S√≠</label>
            <label class="checkbox-item"><input type="radio" name="incluir_mensaje" value="No" checked> No</label>
          </div>
          <textarea name="mensaje_personalizado" rows="3" placeholder="Escribe el mensaje que quieres incluir (si aplica)..." style="display:none;"></textarea>
        </div>

        <!-- --- Secci√≥n 1: Ramos personalizados --- -->
        <h6>üåπ Ramos personalizados</h6>
        <div class="form-group">
          <label>¬øQu√© tipo de flores prefieres? (puedes elegir varios)</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="checkbox" name="tipo_flores" value="Rosas"> Rosas</label>
            <label class="checkbox-item"><input type="checkbox" name="tipo_flores" value="Girasoles"> Girasoles</label>
            <label class="checkbox-item"><input type="checkbox" name="tipo_flores" value="Tulipanes"> Tulipanes</label>
            <label class="checkbox-item"><input type="checkbox" name="tipo_flores" value="Mixto"> Mixto</label>
            <label class="checkbox-item"><input type="checkbox" name="tipo_flores" value="Otro"> Otro</label>
            <input type="text" name="tipo_flores_otro" placeholder="Si elegiste 'Otro', escribe aqu√≠..." style="width:100%; margin-top:6px;">
          </div>
        </div>

        <div class="form-group">
          <label>¬øCu√°ntas flores deseas aproximadamente?</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="radio" name="cantidad_flores" value="6"> 6</label>
            <label class="checkbox-item"><input type="radio" name="cantidad_flores" value="12"> 12</label>
            <label class="checkbox-item"><input type="radio" name="cantidad_flores" value="24"> 24</label>
            <label class="checkbox-item"><input type="radio" name="cantidad_flores" value="Otro"> Otros</label>
            <input type="text" name="cantidad_flores_otro" placeholder="Si elegiste 'Otros', escribe la cantidad aproximada..." style="width:100%; margin-top:6px;">
          </div>
        </div>

        <div class="form-group">
          <label>¬øQu√© envoltura prefieres?</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="checkbox" name="envoltura" value="Papel kraft"> Papel kraft</label>
            <label class="checkbox-item"><input type="checkbox" name="envoltura" value="Celof√°n"> Celof√°n transparente</label>
            <label class="checkbox-item"><input type="checkbox" name="envoltura" value="Papel colores"> Papel de colores</label>
            <label class="checkbox-item"><input type="checkbox" name="envoltura" value="Tela decorativa"> Tela decorativa</label>
            <label class="checkbox-item"><input type="checkbox" name="envoltura" value="Otro"> Otro</label>
            <input type="text" name="envoltura_otro" placeholder="Si elegiste 'Otro', escribe aqu√≠..." style="width:100%; margin-top:6px;">
          </div>
        </div>

        <div class="form-group">
          <label>¬øDeseas agregar alg√∫n detalle al ramo? (mo√±o, accesorio, tem√°tica, etc.)</label>
          <textarea name="detalles_ramo" rows="2" placeholder="Describe detalles adicionales para el ramo..."></textarea>
        </div>

        <!-- --- Secci√≥n 2: Cartas personalizadas --- -->
        <h6>üíå Cartas personalizadas</h6>
        <div class="form-group">
          <label>¬øQu√© estilo de redacci√≥n prefieres?</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="radio" name="estilo_carta" value="Rom√°ntica"> Rom√°ntica</label>
            <label class="checkbox-item"><input type="radio" name="estilo_carta" value="Divertida"> Divertida</label>
            <label class="checkbox-item"><input type="radio" name="estilo_carta" value="Formal"> Formal</label>
            <label class="checkbox-item"><input type="radio" name="estilo_carta" value="Inspiradora"> Inspiradora</label>
            <label class="checkbox-item"><input type="radio" name="estilo_carta" value="Libre"> Libre</label>
          </div>
        </div>

        <div class="form-group">
          <label>Mensaje que deseas escribir en la carta</label>
          <textarea name="mensaje_carta" rows="4" placeholder="Escribe aqu√≠ el mensaje que quieras incluir en la carta..."></textarea>
        </div>

        <div class="form-group">
          <label>¬øQu√© extensi√≥n quieres para la carta?</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="radio" name="extension_carta" value="Corta"> Corta - 1 p√°rrafo</label>
            <label class="checkbox-item"><input type="radio" name="extension_carta" value="Media"> Media - 1 p√°gina larga</label>
            <label class="checkbox-item"><input type="radio" name="extension_carta" value="Larga"> Larga - 2 o m√°s p√°ginas</label>
            <label class="checkbox-item"><input type="radio" name="extension_carta" value="Otro"> Otros</label>
            <input type="text" name="extension_carta_otro" placeholder="Si elegiste 'Otros', escribe aqu√≠..." style="width:100%; margin-top:6px;">
          </div>
        </div>

        <!-- --- Elementos de personalizaci√≥n generales --- -->
        <h6>Elementos de personalizaci√≥n</h6>
        <div class="form-group">
          <label>¬øQu√© colores prefieres que predominen en el regalo? (elige al menos 1)</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="checkbox" name="colores" value="Rojo"> Rojo</label>
            <label class="checkbox-item"><input type="checkbox" name="colores" value="Rosa"> Rosa</label>
            <label class="checkbox-item"><input type="checkbox" name="colores" value="Blanco"> Blanco</label>
            <label class="checkbox-item"><input type="checkbox" name="colores" value="Azul"> Azul</label>
            <label class="checkbox-item"><input type="checkbox" name="colores" value="Amarillo"> Amarillo</label>
            <label class="checkbox-item"><input type="checkbox" name="colores" value="Dorado"> Dorado</label>
            <label class="checkbox-item"><input type="checkbox" name="colores" value="Negro"> Negro</label>
            <input type="text" name="colores_otro" placeholder="Si eliges 'Otro', escribe aqu√≠..." style="width:100%; margin-top:6px;">
          </div>
        </div>

        <div class="form-group">
          <label>¬øDeseas agregar alg√∫n detalle adicional (regalo extra, peluche, tarjeta, etc.)?</label>
          <textarea name="detalles_adicionales" rows="3" placeholder="Describe cualquier otro elemento que quieras agregar..."></textarea>
        </div>

        <div class="form-group">
          <label>¬øPara cu√°ndo lo necesitas?</label>
          <input type="date" name="fecha_limite">
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" name="acepto_condiciones" required> He le√≠do y acepto que algunas personalizaciones pueden requerir ajustes o tarifas adicionales; el vendedor me contactar√° si es necesario. <span style="color:#d33">*</span>
          </label>
        </div>

        <button type="submit" class="btn-enviar w-100">Registrar Respuestas</button>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const textoLibreCard = document.getElementById("textoLibreCard");
  const formTextoLibre = document.getElementById("formTextoLibre");
  const bocetoCard = document.getElementById("bocetoCard");
  const formBoceto = document.getElementById("formBoceto");
  const formularioGuiadoCard = document.getElementById("formularioGuiadoCard");
  const formGuiado = document.getElementById("formGuiado");


  // Mostrar/ocultar textarea de mensaje_personalizado seg√∫n elecci√≥n
  const radioIncluir = formGuiado.querySelectorAll('input[name="incluir_mensaje"]');
  const mensajePersonalizado = formGuiado.querySelector('textarea[name="mensaje_personalizado"]');
  radioIncluir.forEach(r => r.addEventListener('change', () => {
    if (formGuiado.querySelector('input[name="incluir_mensaje"]:checked')?.value === 'S√≠') {
      mensajePersonalizado.style.display = 'block';
      mensajePersonalizado.required = true;
    } else {
      mensajePersonalizado.style.display = 'none';
      mensajePersonalizado.required = false;
    }
  }));

  // Helper: obtener valores de checkboxes por nombre
  const getCheckedValues = (form, name) => {
    const nodes = form.querySelectorAll(`[name="${name}"]:checked`);
    return Array.from(nodes).map(n => n.value);
  };

  // Helper: obtener valor de un input de texto siguiente (campo _otro)
  const getOtherIfAny = (form, baseName, otherName) => {
    const arr = getCheckedValues(form, baseName);
    const otherVal = form.querySelector(`input[name="${otherName}"]`)?.value?.trim();
    if (otherVal) arr.push(otherVal);
    return arr;
  };

  // Funci√≥n para manejar la apertura de tarjetas
  const toggleCard = (card, form) => {
      card.addEventListener("click", (e) => {
        if (e.target.closest("form")) return; // Si clickea dentro del form, no cerrar
        
        // Cerrar otros (opcional, para limpieza visual)
        if (form.style.display === "none") {
            // Resetear estados visuales de otros
            document.querySelectorAll('form').forEach(f => f.style.display = 'none');
            document.querySelectorAll('.opcion-card').forEach(c => c.classList.remove('active'));
            
            form.style.display = "block";
            card.classList.add('active');
        } else {
            form.style.display = "none";
            card.classList.remove('active');
        }
      });
  };

  toggleCard(textoLibreCard, formTextoLibre);
  toggleCard(bocetoCard, formBoceto);
  toggleCard(formularioGuiadoCard, formGuiado);

  // --- L√ìGICA OPCI√ìN 2 (Texto Libre) ---
  formTextoLibre.addEventListener("submit", async (e) => {
    e.preventDefault();
    const texto = document.getElementById("textoPersonalizado").value.trim();
    if (!texto) {
      Swal.fire({ title: "‚ö† Campo vac√≠o", text: "Por favor escribe un texto antes de enviar.", icon: "warning", confirmButtonColor: "#3085d6" });
      return;
    }
    const confirmacion = await Swal.fire({
      title: "¬øGuardar texto personalizado?", text: "¬øDeseas guardar esta descripci√≥n en tu pedido?", icon: "question", showCancelButton: true, confirmButtonText: "S√≠, guardar", cancelButtonText: "Cancelar", confirmButtonColor: "#3085d6", cancelButtonColor: "#d33"
    });
    if (!confirmacion.isConfirmed) return;

    try {
      const response = await fetch("/guardar_texto_personalizado/{{ id_producto }}", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `texto_personalizado=${encodeURIComponent(texto)}`
      });
      const result = await response.json();
      if (result.success) {
        Swal.fire({ title: "‚úÖ ¬°Guardado con √©xito!", text: "Tu texto personalizado fue registrado correctamente.", icon: "success", confirmButtonColor: "#3085d6" });
      } else {
        Swal.fire({ title: "‚ùå Error al guardar", text: result.message, icon: "error", confirmButtonColor: "#d33" });
      }
    } catch (error) {
      Swal.fire({ title: "‚ö† Error de conexi√≥n", text: "No se pudo conectar con el servidor.", icon: "warning", confirmButtonColor: "#d33" });
    }
  });

  // --- L√ìGICA OPCI√ìN 3 (Boceto) ---
  formBoceto.addEventListener("submit", async (e) => {
    e.preventDefault();
    const file = document.getElementById("imagenBoceto").files[0];
    if (!file) {
      Swal.fire({ title: "‚ö† Archivo no seleccionado", text: "Selecciona una imagen antes de subir.", icon: "warning", confirmButtonColor: "#3085d6" });
      return;
    }
    const confirmacion = await Swal.fire({
      title: "¬øSubir boceto?", text: "¬øDeseas guardar esta imagen como referencia personalizada?", icon: "question", showCancelButton: true, confirmButtonText: "S√≠, subir", cancelButtonText: "Cancelar", confirmButtonColor: "#3085d6", cancelButtonColor: "#d33"
    });
    if (!confirmacion.isConfirmed) return;

    const formData = new FormData();
    formData.append("imagen_personalizada", file);

    try {
      const response = await fetch("/subir_boceto/{{ id_producto }}", {
        method: "POST", body: formData
      });
      if (response.ok) {
        Swal.fire({ title: "‚úÖ ¬°Boceto subido!", text: "Tu imagen fue registrada correctamente.", icon: "success", confirmButtonColor: "#3085d6" });
      } else {
        Swal.fire({ title: "‚ùå Error al subir", text: "Ocurri√≥ un problema al guardar el boceto.", icon: "error", confirmButtonColor: "#d33" });
      }
    } catch (error) {
      Swal.fire({ title: "‚ö† Error de conexi√≥n", text: "No se pudo conectar con el servidor.", icon: "warning", confirmButtonColor: "#d33" });
    }
  });

  // --- L√ìGICA OPCI√ìN 4 (FORMULARIO GUIADO) ---
  formGuiado.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Validaciones client-side b√°sicas
    const nombre = formGuiado.querySelector('input[name="contact_nombre"]').value.trim();
    const email = formGuiado.querySelector('input[name="contact_email"]').value.trim();
    const telefono = formGuiado.querySelector('input[name="contact_telefono"]').value.trim();
    const productoInfo = formGuiado.querySelector('input[name="producto_info"]').value.trim();
    const destinatario = formGuiado.querySelector('input[name="destinatario_nombre"]').value.trim();
    const ocasion = formGuiado.querySelector('select[name="ocasion"]').value;
    const estilo = formGuiado.querySelector('input[name="estilo"]:checked');

    if (!nombre || !email || !telefono || !productoInfo || !destinatario || !ocasion || !estilo) {
      return Swal.fire("‚ö† Campos obligatorios", "Por favor completa los campos marcados con * antes de enviar.", "warning");
    }

    // Asegurar al menos 1 color seleccionado
    const colores = getCheckedValues(formGuiado, 'colores');
    if (colores.length === 0) {
      return Swal.fire("‚ö† Falta color", "Selecciona al menos un color de preferencia.", "warning");
    }

    // Construir objeto data
    const data = {
      contacto: {
        nombre, email, telefono
      },
      producto_info: productoInfo,
      destinatario: {
        nombre: destinatario,
        relacion: formGuiado.querySelector('input[name="relacion"]:checked') ? formGuiado.querySelector('input[name="relacion"]:checked').value : null,
        relacion_otro: formGuiado.querySelector('input[name="relacion_otro"]').value.trim()
      },
      ocasion: ocasion,
      estilo: formGuiado.querySelector('input[name="estilo"]:checked')?.value || formGuiado.querySelector('input[name="estilo_otro"]')?.value,
      estilo_otro: formGuiado.querySelector('input[name="estilo_otro"]').value.trim(),
      incluir_mensaje: formGuiado.querySelector('input[name="incluir_mensaje"]:checked')?.value || 'No',
      mensaje_personalizado: formGuiado.querySelector('textarea[name="mensaje_personalizado"]').value.trim(),

      // Ramos
      ramos: {
        tipos: getOtherIfAny(formGuiado, 'tipo_flores', 'tipo_flores_otro'),
        cantidad: formGuiado.querySelector('input[name="cantidad_flores"]:checked') ? formGuiado.querySelector('input[name="cantidad_flores"]:checked').value : null,
        cantidad_otro: formGuiado.querySelector('input[name="cantidad_flores_otro"]').value.trim(),
        envoltura: getOtherIfAny(formGuiado, 'envoltura', 'envoltura_otro'),
        detalles: formGuiado.querySelector('textarea[name="detalles_ramo"]').value.trim()
      },

      // Cartas
      carta: {
        estilo: formGuiado.querySelector('input[name="estilo_carta"]:checked') ? formGuiado.querySelector('input[name="estilo_carta"]:checked').value : null,
        mensaje: formGuiado.querySelector('textarea[name="mensaje_carta"]').value.trim(),
        extension: formGuiado.querySelector('input[name="extension_carta"]:checked') ? formGuiado.querySelector('input[name="extension_carta"]:checked').value : null,
        extension_otro: formGuiado.querySelector('input[name="extension_carta_otro"]').value.trim()
      },

      // Elementos generales
      colores: getOtherIfAny(formGuiado, 'colores', 'colores_otro'),
      detalles_adicionales: formGuiado.querySelector('textarea[name="detalles_adicionales"]').value.trim(),
      fecha_limite: formGuiado.querySelector('input[name="fecha_limite"]').value || null,
      acepto_condiciones: !!formGuiado.querySelector('input[name="acepto_condiciones"]').checked
    };

    // Confirmaci√≥n
    const confirmacion = await Swal.fire({
      title: "¬øRegistrar Respuestas?",
      text: "Se guardar√°n tus preferencias para este pedido.",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "S√≠, registrar",
      cancelButtonText: "Cancelar",
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33"
    });

    if (!confirmacion.isConfirmed) return;

    // Enviar JSON al backend (mismo endpoint)
    try {
      const response = await fetch(`/registrar_formulario/{{ id_producto }}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      if (result.success) {
        Swal.fire({
          title: "‚úÖ ¬°Formulario Registrado!",
          text: "Tus respuestas han sido guardadas. ¬øQuieres ir al carrito?",
          icon: "success",
          showCancelButton: true,
          confirmButtonText: "Ir al Carrito",
          cancelButtonText: "Seguir aqu√≠",
          confirmButtonColor: "#3085d6"
        }).then((res) => {
          if (res.isConfirmed) window.location.href = "{{ url_for('carrito_bp.ver') }}";
        });
      } else {
        Swal.fire({ title: "‚ùå Error", text: result.message || "Error desconocido", icon: "error", confirmButtonColor: "#d33" });
      }
    } catch (err) {
      console.error(err);
      Swal.fire({ title: "‚ö† Error de conexi√≥n", text: "No se pudo conectar con el servidor.", icon: "warning", confirmButtonColor: "#d33" });
    }
  });
});
</script>
{% endblock %}