{% extends "base.html" %}
{% block title %}Personaliza {{ producto.nombre }} - HandiGenius{% endblock %}

{% block content %}
<style>
  .personalizar-container {
    margin-top: 30px;
    background: white;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  .personalizar-grid {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 30px;
  }

  .preview-area {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #f9fafb;
    border-radius: 15px;
    padding: 20px;
  }

  .preview-area img {
    max-width: 350px;
    position: absolute;
    transition: opacity 0.3s ease;
  }

  .opciones-panel {
    background: #f5f7fa;
    border-radius: 20px;
    padding: 20px;
  }

  .selector {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 15px 0;
  }

  .selector button {
    background: #0080FF;
    color: white;
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    font-size: 18px;
    transition: background 0.2s;
  }

  .selector button:hover {
    background: #0066CC;
  }

  .btn-save {
    background: linear-gradient(135deg, #0080FF, #3399FF);
    color: white;
    border: none;
    border-radius: 15px;
    padding: 10px 20px;
    font-weight: 600;
    width: 100%;
    transition: all 0.3s;
  }

  .btn-save:hover {
    background: linear-gradient(135deg, #0066CC, #2685E6);
    transform: translateY(-2px);
  }

  .btn-volver {
    position: fixed !important;
    top: 80px; /* baja un poco para no chocar con el navbar */
    left: 25px;
    background-color: #007bff !important; /* Azul igual al navbar */
    color: #fff !important;
    padding: 10px 18px;
    border-radius: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    text-decoration: none !important;
    transition: all 0.25s ease-in-out;
    z-index: 9999;
  }

  .btn-volver:hover {
    background-color: #0056b3 !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 123, 255, 0.45);
    color: #fff !important;
    text-decoration: none !important;
  }

  .btn-volver i {
    font-size: 1.1rem;
  }
</style>

<a href="{{ url_for('productos_bp.panel_personalizacion', id_producto=producto.id_producto) }}" 
   class="btn-volver">
  <i class="bi bi-arrow-left"></i> Volver al panel 
</a>

<div class="container personalizar-container">
  <h1 class="text-center mb-4">
    <i class="bi bi-palette"></i> Personaliza tu {{ producto.nombre }}
  </h1>

  <div class="personalizar-grid">
    <!-- Vista previa -->
    <div class="preview-area">
      <!-- Imagen base -->
      <img id="base" src="{{ url_for('static', filename='personalizacion/base_ramo.png') }}" alt="Ramo base">

      <!-- Capas -->
      <img id="flores" src="{{ url_for('static', filename='personalizacion/flores_rojas.png') }}" alt="Flores principales">
      <img id="secundarias" src="{{ url_for('static', filename='personalizacion/glipsofila.png') }}" alt="Flores secundarias">
      <img id="papel" src="{{ url_for('static', filename='personalizacion/papel_kraft.png') }}" alt="Papel">
      <img id="cinta" src="{{ url_for('static', filename='personalizacion/cinta_azul.png') }}" alt="Cinta">
    </div>

    <!-- Panel -->
    <div class="opciones-panel">
      <h4><i class="bi bi-flower3"></i> Flores principales</h4>
      <div class="selector">
        <button id="prevFlores">←</button>
        <span id="floresNombre">Rojas</span>
        <button id="nextFlores">→</button>
      </div>

      <h4><i class="bi bi-flower2"></i> Flores secundarias</h4>
      <div class="selector">
        <button id="prevSecundarias">←</button>
        <span id="secundariasNombre">Glipsofila</span>
        <button id="nextSecundarias">→</button>
      </div>

      <h4><i class="bi bi-file-earmark"></i> Papel</h4>
      <div class="selector">
        <button id="prevPapel">←</button>
        <span id="papelNombre">Kraft</span>
        <button id="nextPapel">→</button>
      </div>

      <h4><i class="bi bi-ribbon"></i> Cinta</h4>
      <div class="selector">
        <button id="prevCinta">←</button>
        <span id="cintaNombre">Azul</span>
        <button id="nextCinta">→</button>
      </div>

      <button id="guardarPersonalizacion" class="btn-save mt-4">
        <i class="bi bi-check-circle"></i> Guardar personalización
      </button>
    </div>
  </div>
</div>

<script>
  const opciones = {
    flores: [
      { nombre: "Rojas", src: "{{ url_for('static', filename='personalizacion/flores_rojas.png') }}" },
      { nombre: "Azules", src: "{{ url_for('static', filename='personalizacion/flores_azules.png') }}" },
      { nombre: "Amarillas", src: "{{ url_for('static', filename='personalizacion/flores_amarillas.png') }}" },
      { nombre: "Rosadas", src: "{{ url_for('static', filename='personalizacion/flores_rosadas.png') }}" },
      { nombre: "Moradas", src: "{{ url_for('static', filename='personalizacion/flores_moradas.png') }}" },
      { nombre: "Blancas", src: "{{ url_for('static', filename='personalizacion/flores_blancas.png') }}" }
    ],
    secundarias: [
      { nombre: "Glipsofila", src: "{{ url_for('static', filename='personalizacion/glipsofila.png') }}" },
      { nombre: "Limonium", src: "{{ url_for('static', filename='personalizacion/limonium.png') }}" },
      { nombre: "Asparagus", src: "{{ url_for('static', filename='personalizacion/asparagus.png') }}" },
      { nombre: "Ruscus", src: "{{ url_for('static', filename='personalizacion/ruscus.png') }}" },
      { nombre: "Solidago", src: "{{ url_for('static', filename='personalizacion/solidago.png') }}" },
      { nombre: "Escabiosa", src: "{{ url_for('static', filename='personalizacion/escabiosa.png') }}" }
    ],
    papel: [
      { nombre: "Kraft", src: "{{ url_for('static', filename='personalizacion/papel_kraft.png') }}" },
      { nombre: "Rosado", src: "{{ url_for('static', filename='personalizacion/papel_rosado.png') }}" },
      { nombre: "Azul Claro", src: "{{ url_for('static', filename='personalizacion/papel_azul_claro.png') }}" },
      { nombre: "Negro", src: "{{ url_for('static', filename='personalizacion/papel_negro.png') }}" },
      { nombre: "Blanco", src: "{{ url_for('static', filename='personalizacion/papel_blanco.png') }}" }
    ],
    cinta: [
      { nombre: "Azul", src: "{{ url_for('static', filename='personalizacion/cinta_azul.png') }}" },
      { nombre: "Amarilla", src: "{{ url_for('static', filename='personalizacion/cinta_amarilla.png') }}" },
      { nombre: "Roja", src: "{{ url_for('static', filename='personalizacion/cinta_roja.png') }}" },
      { nombre: "Rosa", src: "{{ url_for('static', filename='personalizacion/cinta_rosa.png') }}" },
      { nombre: "Blanca", src: "{{ url_for('static', filename='personalizacion/cinta_blanca.png') }}" },
      { nombre: "Negra", src: "{{ url_for('static', filename='personalizacion/cinta_negra.png') }}" }
    ]
  };

  const indices = { flores: 0, secundarias: 0, papel: 0, cinta: 0 };

  function actualizarVista(tipo) {
    document.getElementById(tipo).src = opciones[tipo][indices[tipo]].src;
    document.getElementById(`${tipo}Nombre`).innerText = opciones[tipo][indices[tipo]].nombre;
  }

  function cambiar(tipo, dir) {
    indices[tipo] = (indices[tipo] + dir + opciones[tipo].length) % opciones[tipo].length;
    actualizarVista(tipo);
  }

  document.getElementById("prevFlores").onclick = () => cambiar("flores", -1);
  document.getElementById("nextFlores").onclick = () => cambiar("flores", 1);
  document.getElementById("prevSecundarias").onclick = () => cambiar("secundarias", -1);
  document.getElementById("nextSecundarias").onclick = () => cambiar("secundarias", 1);
  document.getElementById("prevPapel").onclick = () => cambiar("papel", -1);
  document.getElementById("nextPapel").onclick = () => cambiar("papel", 1);
  document.getElementById("prevCinta").onclick = () => cambiar("cinta", -1);
  document.getElementById("nextCinta").onclick = () => cambiar("cinta", 1);

document.getElementById("guardarPersonalizacion").onclick = async () => {
  const plantilla = {
    flores: opciones.flores[indices.flores].nombre,
    flores_url: opciones.flores[indices.flores].src,
    secundarias: opciones.secundarias[indices.secundarias].nombre,
    papel: opciones.papel[indices.papel].nombre,
    cinta: opciones.cinta[indices.cinta].nombre
  };

  const confirmacion = await Swal.fire({
    title: "¿Guardar personalización?",
    text: "¿Deseas guardar los cambios realizados a tu producto?",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Sí, guardar",
    cancelButtonText: "Cancelar",
    confirmButtonColor: "#3085d6",
    cancelButtonColor: "#d33"
  });

  if (!confirmacion.isConfirmed) return;

  try {
    const response = await fetch(`/guardar_plantilla/{{ producto.id_producto }}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(plantilla)
    });

    const result = await response.json();
    if (result.success) {
      Swal.fire({
        title: "✅ ¡Guardado con éxito!",
        text: "Tu personalización fue registrada correctamente.",
        icon: "success",
        confirmButtonColor: "#3085d6"
      });
    } else {
      Swal.fire({
        title: "❌ Error",
        text: "Ocurrió un problema al guardar: " + result.message,
        icon: "error",
        confirmButtonColor: "#d33"
      });
    }
  } catch (error) {
    console.error("Error:", error);
    Swal.fire({
      title: "⚠️ Error de conexión",
      text: "No se pudo conectar con el servidor.",
      icon: "warning",
      confirmButtonColor: "#d33"
    });
  }
};
</script>
{% endblock %}